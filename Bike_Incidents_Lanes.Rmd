---
title: "Bike Incidents & Existing Lanes"
output: github_document
---

# Packages & Data

```{r message = FALSE}
library(tidyverse)
library(ggmap)
library(osmdata)
library(tidyverse)
library(sp)
library(sf)
library(ggspatial)
library(ggmap)
library(writexl)
library(osmar)
library(osrmr)
library(GGally)

load("data/bike_data.RData")
```

# Visualizaing

```{r message = FALSE}
map2 <- get_map(location = moco_bb)

ggmap(map2) +
  geom_point(data = bike_incidents, aes(x = Longitude, y = Latitude, color = `Injury Severity`)) +
  layer_spatial(cycleways) + 
  labs(title = "Bike Incident Severity Map with Cycleways")

ggmap(map2) +
  layer_spatial(streets)
```

# Match Incidents to Cycleway status

This makes the assumption that if a cycleway (bike lane or trail) exists, the cyclist was using it.

```{r}
#snap points to the lines (road segments) that they are nearest to

sp_bike_incidents <- bike_incidents %>%
  select(Latitude,Longitude) %>%
  as.matrix()

sp_bike_incidents <- SpatialPointsDataFrame(coords = sp_bike_incidents, data = bike_incidents)
sf_bike_incidents <- st_as_sf(sp_bike_incidents)

cycleways_df <- SpatialLinesDataFrame(cycleways)
  
snapped_points <- st_nearest_points(sf_bike_incidents,sf_cycleways,pairwise = FALSE)

#### will have to come back to this
# cause it's broke af


#trying again, cause this is the key to *everything else*
test_accident <- c(bike_incidents$Longitude[1],bike_incidents$Latitude[1])

streets <- as(osm_streets$osm_lines,"SpatialLinesDataFrame")

test_street <- as(streets@lines$`697630636`,"SpatialPoints")
test_street_id <- streets@lines$`697630636`@ID

distm(test_accident,test_street@coords)

lengthLine(test_street@coords)
#this makes meters

#and find out which street it is:
street_name <- matched_streets %>%
  filter(osm_id == "697630636")

# Length of road data (for incident per mile calculation)

streets_test_df <- data.frame(streets@data)

quince_orchard <- streets_test_df %>%
  filter(name == "Quince Orchard Road") 
#OK I get it.
#Each road has multiple segments on our list because its characteristics can change

quince_length <- 0

for (i in quince_orchard$osm_id) {

x <- paste0("streets@lines$`",i,"`@Lines")

segment <- lengthLine(eval(parse(text = x))[[1]]@coords)

quince_length <- quince_length + segment
}

# IT WORKS IT WORKS OMFG IT WORKS
# next to loop de loop

#1 Loop through the Matched Streets list calculating length
#2 Loop through the matched Streets list and incidents list looking for cycleway status

```


# Correlation of bike lane status to injury severity

```{r}
bike_incidents %>%
  filter(`Pedestrian Location` == 'IN BIKEWAY') %>%
  summarise(n=n())


```

